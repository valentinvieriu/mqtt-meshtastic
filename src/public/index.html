<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meshtastic MQTT Client</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="/css/styles.css" rel="stylesheet">
</head>
<body>

  <!-- Menu Bar -->
  <div class="menubar">
    <div class="menubar-left">
      <i class="fas fa-broadcast-tower"></i>
      <span class="menubar-title">Meshtastic MQTT Client</span>
    </div>
    <div class="menubar-right">
      <span class="menubar-subtitle">Encrypted mesh messaging via MQTT</span>
    </div>
  </div>

  <!-- Main Layout: Activity Bar + Sidebar + Main -->
  <div class="main-layout">

    <!-- Activity Bar (far left icons) -->
    <div class="activity-bar">
      <button class="activity-bar-btn active" data-view="watch" title="Watch Channel">
        <i class="fas fa-satellite-dish"></i>
      </button>
      <button class="activity-bar-btn" data-view="send" title="Send Message">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">

      <!-- ===== Watch Sidebar ===== -->
      <div class="sidebar-view active" id="sidebar-watch">
        <div class="sidebar-header">WATCH</div>

        <!-- Topic Section -->
        <div class="sidebar-section">
          <button class="sidebar-section-header" data-collapse="watch-topic-body">
            <i class="fas fa-chevron-down sidebar-chevron"></i>
            <span>TOPIC</span>
            <span id="watch-mode-indicator" class="mode-badge mode-badge-proto">Protobuf</span>
          </button>
          <div class="sidebar-section-body" id="watch-topic-body">
            <div class="sidebar-field-row">
              <div class="sidebar-field">
                <label>Root</label>
                <input type="text" id="watch-root" value="msh" class="watch-input sidebar-input">
              </div>
              <div class="sidebar-field">
                <label>Region</label>
                <input type="text" id="watch-region" value="EU_868" class="watch-input sidebar-input">
              </div>
            </div>

            <div class="sidebar-field">
              <label>Path (Mode)</label>
              <div class="sidebar-select-wrap">
                <select id="watch-path-select" class="watch-input sidebar-input sidebar-select">
                  <option value="2/e">2/e (Protobuf - Encrypted)</option>
                  <option value="2/json">2/json (JSON - Unencrypted)</option>
                </select>
                <i class="fas fa-chevron-down sidebar-select-icon"></i>
              </div>
            </div>

            <div class="sidebar-field">
              <label class="sidebar-label-with-actions">
                <span>Channel</span>
                <span class="field-actions">
                  <button type="button" id="watch-channel-default-btn" class="field-action-btn" title="Reset to default channel">Default</button>
                </span>
              </label>
              <div class="sidebar-select-wrap">
                <select id="watch-channel-select" class="watch-input sidebar-input sidebar-select">
                  <option value="LongFast">LongFast</option>
                  <option value="LongSlow">LongSlow</option>
                  <option value="MediumFast">MediumFast</option>
                  <option value="MediumSlow">MediumSlow</option>
                  <option value="ShortFast">ShortFast</option>
                  <option value="ShortSlow">ShortSlow</option>
                  <option value="VeryLongSlow">VeryLongSlow</option>
                  <option value="mqtt">mqtt</option>
                  <option value="custom">Custom...</option>
                </select>
                <i class="fas fa-chevron-down sidebar-select-icon"></i>
              </div>
              <input type="text" id="watch-channel-custom" placeholder="Custom channel" class="watch-input sidebar-input hidden" style="margin-top:4px">
            </div>

            <button id="subscribe-btn" class="sidebar-btn sidebar-btn-primary">
              <i class="fas fa-plus"></i> Subscribe
            </button>
          </div>
        </div>

        <!-- Decryption Key Section -->
        <div class="sidebar-section">
          <button class="sidebar-section-header collapsed" data-collapse="watch-key-body">
            <i class="fas fa-chevron-down sidebar-chevron"></i>
            <span>DECRYPTION KEY</span>
          </button>
          <div class="sidebar-section-body collapsed-body" id="watch-key-body">
            <div class="sidebar-field">
              <label class="sidebar-label-with-actions">
                <span>Key</span>
                <span class="field-actions">
                  <button type="button" id="watch-key-default-btn" class="field-action-btn" title="Reset to default key">AQ==</button>
                </span>
              </label>
              <input type="text" id="watch-key" value="AQ==" class="watch-input sidebar-input font-mono">
              <div class="sidebar-hint">Key for decrypting messages on this channel</div>
            </div>
          </div>
        </div>

        <!-- Subscriptions Section -->
        <div class="sidebar-section">
          <button class="sidebar-section-header" data-collapse="subscriptions-body">
            <i class="fas fa-chevron-down sidebar-chevron"></i>
            <span>SUBSCRIPTIONS</span>
          </button>
          <div class="sidebar-section-body" id="subscriptions-body">
            <div id="subscription-list" class="subscription-list">
              <span class="sidebar-empty">Loading...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== Send Sidebar ===== -->
      <div class="sidebar-view" id="sidebar-send">
        <div class="sidebar-header">SEND</div>

        <!-- Topic Section -->
        <div class="sidebar-section">
          <button class="sidebar-section-header" data-collapse="send-topic-body">
            <i class="fas fa-chevron-down sidebar-chevron"></i>
            <span>TOPIC</span>
            <span id="send-mode-indicator" class="mode-badge mode-badge-proto">Protobuf</span>
          </button>
          <div class="sidebar-section-body" id="send-topic-body">
            <div class="sidebar-field-row">
              <div class="sidebar-field">
                <label>Root</label>
                <input type="text" id="send-root" value="msh" class="send-input sidebar-input">
              </div>
              <div class="sidebar-field">
                <label>Region</label>
                <input type="text" id="send-region" value="EU_868" class="send-input sidebar-input">
              </div>
            </div>

            <div class="sidebar-field">
              <label>Path (Mode)</label>
              <div class="sidebar-select-wrap">
                <select id="send-path-select" class="send-input sidebar-input sidebar-select">
                  <option value="2/e">2/e (Protobuf - Encrypted)</option>
                  <option value="2/json">2/json (JSON - Unencrypted)</option>
                </select>
                <i class="fas fa-chevron-down sidebar-select-icon"></i>
              </div>
            </div>

            <div class="sidebar-field">
              <label class="sidebar-label-with-actions">
                <span>Channel</span>
                <span class="field-actions">
                  <button type="button" id="send-channel-default-btn" class="field-action-btn" title="Reset to default channel">Default</button>
                </span>
              </label>
              <div class="sidebar-select-wrap">
                <select id="send-channel-select" class="send-input sidebar-input sidebar-select">
                  <option value="LongFast">LongFast</option>
                  <option value="LongSlow">LongSlow</option>
                  <option value="MediumFast">MediumFast</option>
                  <option value="MediumSlow">MediumSlow</option>
                  <option value="ShortFast">ShortFast</option>
                  <option value="ShortSlow">ShortSlow</option>
                  <option value="VeryLongSlow">VeryLongSlow</option>
                  <option value="mqtt">mqtt</option>
                  <option value="custom">Custom...</option>
                </select>
                <i class="fas fa-chevron-down sidebar-select-icon"></i>
              </div>
              <input type="text" id="send-channel-custom" placeholder="Custom channel" class="send-input sidebar-input hidden" style="margin-top:4px">
            </div>
          </div>
        </div>

        <!-- Message Section -->
        <div class="sidebar-section">
          <button class="sidebar-section-header" data-collapse="send-message-body">
            <i class="fas fa-chevron-down sidebar-chevron"></i>
            <span>MESSAGE</span>
          </button>
          <div class="sidebar-section-body" id="send-message-body">

            <!-- JSON Mode Warning -->
            <div id="json-mode-warning" class="json-warning hidden">
              <div class="json-warning-inner">
                <i class="fas fa-exclamation-triangle"></i>
                <div>
                  <p class="json-warning-title">JSON Mode - Unencrypted</p>
                  <p class="json-warning-text">Messages are sent as plaintext JSON. The receiving gateway must have a channel named "mqtt" with Downlink enabled.</p>
                </div>
              </div>
            </div>

            <div class="sidebar-field">
              <label class="sidebar-label-with-actions">
                <span>Gateway ID</span>
                <span class="field-actions">
                  <button type="button" id="gateway-default-btn" class="field-action-btn" title="Reset gateway to default">Default</button>
                </span>
              </label>
              <input type="text" id="gateway-id" value="!d844b556" class="send-input sidebar-input font-mono">
            </div>

            <div class="sidebar-field-row">
              <div class="sidebar-field">
                <label class="sidebar-label-with-toggle">
                  <span>Sender</span>
                  <label class="auto-toggle">
                    <input type="checkbox" id="sender-auto" checked>
                    <span>Auto</span>
                  </label>
                </label>
                <input type="text" id="sender-id" value="!d844b556" class="send-input sidebar-input font-mono disabled-input" disabled>
                <div class="sidebar-hint font-mono" id="sender-int">Int: -</div>
              </div>
              <div class="sidebar-field">
                <label>Receiver</label>
                <input type="text" id="receiver-id" value="^all" placeholder="!hex or ^all" class="send-input sidebar-input font-mono">
                <div class="sidebar-hint font-mono" id="receiver-int">Int: -</div>
                <div class="sidebar-presets">
                  <button type="button" id="receiver-broadcast-btn" class="preset-btn">^all</button>
                  <button type="button" id="receiver-gateway-btn" class="preset-btn">Gateway</button>
                  <button type="button" id="receiver-default-btn" class="preset-btn">Default</button>
                </div>
              </div>
            </div>

            <div class="sidebar-field">
              <label>Message</label>
              <textarea id="message-text" rows="3" class="send-input sidebar-input sidebar-textarea">Hello from web!</textarea>
            </div>

            <div class="sidebar-field" id="key-group">
              <label class="sidebar-label-with-actions">
                <span>Encryption Key</span>
                <span class="field-actions">
                  <button type="button" id="key-default-btn" class="field-action-btn" title="Reset key to default">Default</button>
                </span>
              </label>
              <input type="text" id="encryption-key" value="AQ==" class="send-input sidebar-input font-mono">
              <div class="sidebar-hint" id="encryption-key-hint">Default key from server config</div>
              <div class="sidebar-presets">
                <button type="button" id="key-short-btn" class="preset-btn" title="Meshtastic Default">AQ==</button>
                <button type="button" id="key-gen-128-btn" class="preset-btn" title="Generate random AES-128 key"><i class="fas fa-dice"></i> AES-128</button>
                <button type="button" id="key-gen-256-btn" class="preset-btn" title="Generate random AES-256 key"><i class="fas fa-dice"></i> AES-256</button>
              </div>
            </div>

            <button id="send-btn" class="sidebar-btn sidebar-btn-send">
              <i class="fas fa-paper-plane"></i> Send Message
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== Main Content Area ===== -->
    <div class="editor-area">

      <!-- Watch Main: Activity Log + Detail Panel -->
      <div class="main-view active" id="main-watch">
        <!-- Filter Bar -->
        <div class="tab-bar">
          <div class="tab-bar-tabs">
            <span class="tab-bar-label"><i class="fas fa-stream"></i> Activity Log</span>
          </div>
          <div class="tab-bar-actions" id="filter-bar">
            <button id="filter-all" class="filter-btn filter-active">All</button>
            <button id="filter-text" class="filter-btn">Text</button>
            <button id="filter-position" class="filter-btn">Position</button>
            <button id="filter-telemetry" class="filter-btn">Telemetry</button>
            <button id="filter-nodeinfo" class="filter-btn">Nodes</button>
            <button id="filter-routing" class="filter-btn">Routing</button>
            <button id="filter-neighbor" class="filter-btn">Neighbors</button>
            <div id="node-filter-pills" class="node-filter-pills">
              <span class="node-filter-hint">Click From/To in activity to add filters</span>
            </div>
            <button id="clear-node-filters" class="filter-btn hidden" title="Clear from/to filters">Clear nodes</button>
            <button id="clear-log" class="filter-btn filter-btn-clear" title="Clear log">
              <i class="fas fa-trash-alt"></i>
            </button>
          </div>
        </div>

        <!-- Split: Activity + Detail -->
        <div class="watch-split">
          <div id="activity-log" class="activity-log">
            <div class="placeholder">
              <i class="fas fa-satellite-dish"></i>
              <span>Waiting for messages...</span>
            </div>
          </div>

          <!-- Detail Panel (hidden until a message is selected) -->
          <div id="detail-panel" class="detail-panel hidden">
            <div class="detail-header">
              <span class="detail-title">Message Detail</span>
              <button id="detail-close" class="detail-close-btn" title="Close">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div id="detail-content" class="detail-content">
            </div>
          </div>
        </div>
      </div>

      <!-- Send Main: Payload Preview -->
      <div class="main-view" id="main-send">
        <div class="tab-bar">
          <div class="tab-bar-tabs">
            <span class="tab-bar-label"><i class="fas fa-code"></i> Payload Preview</span>
          </div>
          <div class="tab-bar-actions">
            <button id="copy-topic" class="preview-copy-btn"><i class="far fa-copy"></i> Copy Topic</button>
            <button id="copy-payload" class="preview-copy-btn"><i class="far fa-copy"></i> Copy Payload</button>
          </div>
        </div>
        <div class="preview-panel">
          <div class="preview-section">
            <div class="preview-header">
              <label>MQTT Topic</label>
            </div>
            <div class="preview-box preview-box-topic">
              <div id="out-topic">...</div>
            </div>
          </div>
          <div class="preview-section preview-section-grow">
            <div class="preview-header">
              <label id="payload-label">Payload (before encryption)</label>
            </div>
            <div class="preview-box preview-box-payload">
              <pre id="out-payload">...</pre>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Status Bar -->
  <div class="statusbar">
    <div class="statusbar-left">
      <div class="statusbar-item">
        <span id="connection-status" class="statusbar-dot dot-connecting"></span>
        <span id="connection-text">Connecting...</span>
      </div>
    </div>
    <div class="statusbar-right">
      <div class="statusbar-item">
        <i class="fas fa-globe-americas"></i> <span id="statusbar-region-text">EU_868</span>
      </div>
      <div class="statusbar-item">
        <i class="fas fa-lock"></i> AES-CTR
      </div>
      <div class="statusbar-item">
        <i class="fas fa-server"></i> <span id="statusbar-broker-text">mqtt.meshtastic.org</span>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast">
    <i class="fas fa-check-circle"></i>
    <span id="toast-message">Message sent!</span>
  </div>

  <script type="module" src="/js/app.js"></script>
</body>
</html>
