<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meshtastic MQTT Client</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link href="/css/styles.css" rel="stylesheet">
</head>
<body>

  <!-- Menu Bar -->
  <div class="menubar">
    <div class="menubar-left">
      <i class="fas fa-broadcast-tower"></i>
      <span class="menubar-title">Meshtastic MQTT Client</span>
    </div>
    <div class="menubar-right">
      <span class="menubar-subtitle">Encrypted mesh messaging via MQTT</span>
    </div>
  </div>

  <!-- Main Layout: Activity Bar + Sidebar + Main -->
  <div class="main-layout">

    <!-- Activity Bar (far left icons) -->
    <div class="activity-bar">
      <button class="activity-bar-btn active" data-view="watch" title="Watch Channel">
        <i class="fas fa-satellite-dish"></i>
      </button>
      <button class="activity-bar-btn" data-view="send" title="Send Message">
        <i class="fas fa-paper-plane"></i>
      </button>
      <button class="activity-bar-btn" data-view="nodes" title="Nodes">
        <i class="fas fa-project-diagram"></i>
      </button>
      <button class="activity-bar-btn" data-view="map" title="Map">
        <i class="fas fa-map-marked-alt"></i>
      </button>
      <button class="activity-bar-btn" data-view="manage" title="Settings" style="margin-top:auto;margin-bottom:4px">
        <i class="fas fa-cog"></i>
      </button>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">

      <!-- ===== Watch Sidebar ===== -->
      <div class="sidebar-view active" id="sidebar-watch">
        <div class="sidebar-header">WATCH</div>

        <!-- Channel Section -->
        <div class="sidebar-section">
          <button class="sidebar-section-header" data-collapse="watch-channel-body">
            <i class="fas fa-chevron-down sidebar-chevron"></i>
            <span>CHANNEL</span>
            <span id="watch-mode-indicator" class="mode-badge mode-badge-proto">Protobuf</span>
          </button>
          <div class="sidebar-section-body" id="watch-channel-body">
            <div class="sidebar-field">
              <label>Network</label>
              <div class="sidebar-select-wrap">
                <select id="watch-network-select" class="watch-input sidebar-input sidebar-select">
                </select>
                <i class="fas fa-chevron-down sidebar-select-icon"></i>
              </div>
            </div>

            <div class="sidebar-field">
              <label>Channel</label>
              <div class="sidebar-select-wrap">
                <select id="watch-channel-select" class="watch-input sidebar-input sidebar-select">
                </select>
                <i class="fas fa-chevron-down sidebar-select-icon"></i>
              </div>
            </div>

            <div class="sidebar-field-row">
              <div class="sidebar-field">
                <label>Region</label>
                <div class="sidebar-select-wrap">
                  <select id="watch-region-select" class="watch-input sidebar-input sidebar-select">
                  </select>
                  <i class="fas fa-chevron-down sidebar-select-icon"></i>
                </div>
              </div>
              <div class="sidebar-field">
                <label>Path</label>
                <div class="sidebar-select-wrap">
                  <select id="watch-path-select" class="watch-input sidebar-input sidebar-select">
                  </select>
                  <i class="fas fa-chevron-down sidebar-select-icon"></i>
                </div>
              </div>
            </div>

            <button id="subscribe-btn" class="sidebar-btn sidebar-btn-primary">
              <i class="fas fa-plus"></i> Subscribe
            </button>
          </div>
        </div>

        <!-- Subscriptions Section -->
        <div class="sidebar-section">
          <button class="sidebar-section-header" data-collapse="subscriptions-body">
            <i class="fas fa-chevron-down sidebar-chevron"></i>
            <span>SUBSCRIPTIONS</span>
          </button>
          <div class="sidebar-section-body" id="subscriptions-body">
            <div id="subscription-list" class="subscription-list">
              <span class="sidebar-empty">Loading...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== Send Sidebar ===== -->
      <div class="sidebar-view" id="sidebar-send">
        <div class="sidebar-header">SEND</div>

        <!-- Message Section -->
        <div class="sidebar-section">
          <button class="sidebar-section-header" data-collapse="send-message-body">
            <i class="fas fa-chevron-down sidebar-chevron"></i>
            <span>MESSAGE</span>
            <span id="send-mode-indicator" class="mode-badge mode-badge-proto">Protobuf</span>
          </button>
          <div class="sidebar-section-body" id="send-message-body">

            <!-- JSON Mode Warning -->
            <div id="json-mode-warning" class="json-warning hidden">
              <div class="json-warning-inner">
                <i class="fas fa-exclamation-triangle"></i>
                <div>
                  <p class="json-warning-title">JSON Mode - Unencrypted</p>
                  <p class="json-warning-text">Messages are sent as plaintext JSON. The receiving gateway must have a channel named "mqtt" with Downlink enabled.</p>
                </div>
              </div>
            </div>

            <div class="sidebar-field">
              <label>Network</label>
              <div class="sidebar-select-wrap">
                <select id="send-network-select" class="send-input sidebar-input sidebar-select">
                </select>
                <i class="fas fa-chevron-down sidebar-select-icon"></i>
              </div>
            </div>

            <div class="sidebar-field">
              <label>Channel</label>
              <div class="sidebar-select-wrap">
                <select id="send-channel-select" class="send-input sidebar-input sidebar-select">
                </select>
                <i class="fas fa-chevron-down sidebar-select-icon"></i>
              </div>
            </div>

            <div class="sidebar-field-row">
              <div class="sidebar-field">
                <label>Region</label>
                <div class="sidebar-select-wrap">
                  <select id="send-region-select" class="send-input sidebar-input sidebar-select">
                  </select>
                  <i class="fas fa-chevron-down sidebar-select-icon"></i>
                </div>
              </div>
              <div class="sidebar-field">
                <label>Path</label>
                <div class="sidebar-select-wrap">
                  <select id="send-path-select" class="send-input sidebar-input sidebar-select">
                  </select>
                  <i class="fas fa-chevron-down sidebar-select-icon"></i>
                </div>
              </div>
            </div>

            <div class="sidebar-field">
              <label>Gateway</label>
              <div class="sidebar-select-wrap">
                <select id="send-gateway-select" class="send-input sidebar-input sidebar-select">
                  <!-- Populated from catalog -->
                </select>
                <i class="fas fa-chevron-down sidebar-select-icon"></i>
              </div>
            </div>

            <div class="sidebar-field-row">
              <div class="sidebar-field">
                <label class="sidebar-label-with-toggle">
                  <span>Sender</span>
                  <label class="auto-toggle">
                    <input type="checkbox" id="sender-auto" checked>
                    <span>Auto</span>
                  </label>
                </label>
                <div class="sidebar-select-wrap">
                  <select id="send-from-select" class="send-input sidebar-input sidebar-select" disabled>
                    <!-- Populated from catalog -->
                  </select>
                  <i class="fas fa-chevron-down sidebar-select-icon"></i>
                </div>
              </div>
              <div class="sidebar-field">
                <label>Receiver</label>
                <div class="sidebar-select-wrap">
                  <select id="send-to-select" class="send-input sidebar-input sidebar-select">
                    <!-- Populated from catalog -->
                  </select>
                  <i class="fas fa-chevron-down sidebar-select-icon"></i>
                </div>
              </div>
            </div>

            <div class="sidebar-field">
              <label>Message</label>
              <textarea id="message-text" rows="3" class="send-input sidebar-input sidebar-textarea">Hello from web!</textarea>
            </div>

            <button id="send-btn" class="sidebar-btn sidebar-btn-send">
              <i class="fas fa-paper-plane"></i> Send Message
            </button>
          </div>
        </div>
      </div>

      <!-- ===== Nodes Sidebar ===== -->
      <div class="sidebar-view" id="sidebar-nodes">
        <div class="sidebar-header">NODES</div>

        <div class="sidebar-section">
          <div class="sidebar-section-body" style="padding-top:8px">
            <input type="text" id="nodes-search" class="sidebar-input" placeholder="Search nodes...">
            <div class="nodes-sort-bar">
              <button class="nodes-sort-btn nodes-sort-active" id="nodes-sort-lastSeenAt" title="Sort by last seen">Recent</button>
              <button class="nodes-sort-btn" id="nodes-sort-name" title="Sort by name">Name</button>
              <button class="nodes-sort-btn" id="nodes-sort-messages" title="Sort by message count">Messages</button>
            </div>
          </div>
        </div>

        <div class="sidebar-section">
          <button class="sidebar-section-header" data-collapse="nodes-discovered-body">
            <i class="fas fa-chevron-down sidebar-chevron"></i>
            <span>DISCOVERED</span>
            <span id="nodes-count-badge" class="entity-count">0</span>
          </button>
          <div class="sidebar-section-body" id="nodes-discovered-body" style="padding:0">
            <div id="nodes-list" class="nodes-list">
              <span class="sidebar-empty" style="padding:8px 12px">No nodes discovered yet</span>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== Map Sidebar ===== -->
      <div class="sidebar-view" id="sidebar-map">
        <div class="sidebar-header">MAP</div>

        <div class="sidebar-section">
          <button class="sidebar-section-header" data-collapse="map-options-body">
            <i class="fas fa-chevron-down sidebar-chevron"></i>
            <span>OPTIONS</span>
          </button>
          <div class="sidebar-section-body" id="map-options-body">
            <div class="manage-form-field">
              <label class="manage-checkbox-label"><input type="checkbox" id="map-auto-fit" checked> Auto-fit bounds</label>
            </div>
            <div class="manage-form-field">
              <label class="manage-checkbox-label"><input type="checkbox" id="map-show-links" checked> Show connections</label>
            </div>
            <div class="manage-form-field">
              <label class="manage-checkbox-label"><input type="checkbox" id="map-show-gateways" checked> Show gateway links</label>
            </div>
            <button id="map-fit-btn" class="sidebar-btn sidebar-btn-primary" style="margin-top:4px">
              <i class="fas fa-expand-arrows-alt"></i> Fit All Nodes
            </button>
          </div>
        </div>

        <div class="sidebar-section">
          <button class="sidebar-section-header" data-collapse="map-legend-body">
            <i class="fas fa-chevron-down sidebar-chevron"></i>
            <span>LEGEND</span>
          </button>
          <div class="sidebar-section-body" id="map-legend-body">
            <div class="map-legend-item"><span class="map-legend-dot map-legend-active"></span> Active (&lt;1h)</div>
            <div class="map-legend-item"><span class="map-legend-dot map-legend-recent"></span> Recent (&lt;24h)</div>
            <div class="map-legend-item"><span class="map-legend-dot map-legend-stale"></span> Stale (&gt;24h)</div>
            <div class="map-legend-item"><span class="map-legend-line map-legend-line-gray"></span> Packet link</div>
            <div class="map-legend-item"><span class="map-legend-line map-legend-line-amber"></span> RF neighbor link</div>
            <div class="map-legend-item"><span class="map-legend-line map-legend-line-teal"></span> Traceroute link</div>
            <div class="map-legend-item"><span class="map-legend-line map-legend-line-blue"></span> Gateway link</div>
          </div>
        </div>

        <div class="sidebar-section" style="flex:1;min-height:0;display:flex;flex-direction:column">
          <button class="sidebar-section-header" data-collapse="map-nodes-body">
            <i class="fas fa-chevron-down sidebar-chevron"></i>
            <span>NODES ON MAP</span>
            <span id="map-nodes-count-badge" class="entity-count">0</span>
          </button>
          <div class="sidebar-section-body" id="map-nodes-body" style="padding:0;flex:1;overflow-y:auto">
            <div id="map-nodes-list" class="nodes-list">
              <span class="sidebar-empty" style="padding:8px 12px">No positioned nodes</span>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== Settings Sidebar (formerly Manage) ===== -->
      <div class="sidebar-view" id="sidebar-manage">
        <div class="sidebar-header">SETTINGS</div>
        <div class="settings-menu">
          <button class="settings-menu-item active" data-settings-category="networks">
            <i class="fas fa-network-wired"></i> Networks
          </button>
          <button class="settings-menu-item" data-settings-category="keys">
            <i class="fas fa-key"></i> Keys
          </button>
          <button class="settings-menu-item" data-settings-category="channels">
            <i class="fas fa-hashtag"></i> Channels
          </button>
          <button class="settings-menu-item" data-settings-category="nodes">
            <i class="fas fa-microchip"></i> Nodes
          </button>
        </div>
      </div>
    </div>

    <!-- ===== Main Content Area ===== -->
    <div class="editor-area">

      <!-- Watch Main: Activity Log + Detail Panel -->
      <div class="main-view active" id="main-watch">
        <!-- Filter Bar -->
        <div class="tab-bar">
          <div class="tab-bar-tabs">
            <span class="tab-bar-label"><i class="fas fa-stream"></i> Activity Log</span>
          </div>
          <div class="tab-bar-actions" id="filter-bar">
            <button id="filter-all" class="filter-btn filter-active">All</button>
            <button id="filter-text" class="filter-btn">Text</button>
            <button id="filter-position" class="filter-btn">Position</button>
            <button id="filter-telemetry" class="filter-btn">Telemetry</button>
            <button id="filter-nodeinfo" class="filter-btn">Nodes</button>
            <button id="filter-routing" class="filter-btn">Routing</button>
            <button id="filter-neighbor" class="filter-btn">Neighbors</button>
            <div id="node-filter-pills" class="node-filter-pills">
              <span class="node-filter-hint">Click From/To in activity to add filters</span>
            </div>
            <button id="clear-node-filters" class="filter-btn hidden" title="Clear from/to filters">Clear nodes</button>
            <button id="clear-log" class="filter-btn filter-btn-clear" title="Clear log">
              <i class="fas fa-trash-alt"></i>
            </button>
          </div>
        </div>

        <!-- Split: Activity + Detail -->
        <div class="watch-split">
          <div id="activity-log" class="activity-log">
            <div class="placeholder">
              <i class="fas fa-satellite-dish"></i>
              <span>Waiting for messages...</span>
            </div>
          </div>

          <!-- Detail Panel (hidden until a message is selected) -->
          <div id="detail-panel" class="detail-panel hidden">
            <div class="detail-header">
              <span class="detail-title">Message Detail</span>
              <button id="detail-close" class="detail-close-btn" title="Close">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div id="detail-content" class="detail-content">
            </div>
          </div>
        </div>
      </div>

      <!-- Send Main: Payload Preview -->
      <div class="main-view" id="main-send">
        <div class="tab-bar">
          <div class="tab-bar-tabs">
            <span class="tab-bar-label"><i class="fas fa-code"></i> Payload Preview</span>
          </div>
          <div class="tab-bar-actions">
            <button id="copy-topic" class="preview-copy-btn"><i class="far fa-copy"></i> Copy Topic</button>
            <button id="copy-payload" class="preview-copy-btn"><i class="far fa-copy"></i> Copy Payload</button>
          </div>
        </div>
        <div class="preview-panel">
          <div class="preview-section">
            <div class="preview-header">
              <label>MQTT Topic</label>
            </div>
            <div class="preview-box preview-box-topic">
              <div id="out-topic">...</div>
            </div>
          </div>
          <div class="preview-section preview-section-grow">
            <div class="preview-header">
              <label id="payload-label">Payload (before encryption)</label>
            </div>
            <div class="preview-box preview-box-payload">
              <pre id="out-payload">...</pre>
            </div>
          </div>
        </div>
      </div>

      <!-- Nodes Main: Dashboard -->
      <div class="main-view" id="main-nodes">
        <div class="tab-bar">
          <div class="tab-bar-tabs">
            <span class="tab-bar-label"><i class="fas fa-project-diagram"></i> <span id="nodes-dashboard-title">Node Dashboard</span></span>
          </div>
        </div>
        <div id="nodes-dashboard" class="nodes-dashboard">
          <div class="manage-placeholder">
            <i class="fas fa-project-diagram"></i>
            <span>Select a node from the sidebar to view its dashboard.</span>
          </div>
        </div>
      </div>

      <!-- Map Main -->
      <div class="main-view" id="main-map">
        <div class="tab-bar">
          <div class="tab-bar-tabs">
            <span class="tab-bar-label"><i class="fas fa-map-marked-alt"></i> <span id="map-summary-text">Mesh Node Map</span></span>
          </div>
        </div>
        <div id="map-container" style="flex:1;min-height:0"></div>
      </div>

      <!-- Settings Main: List + Editor -->
      <div class="main-view" id="main-manage">
        <div class="settings-layout">
          <!-- List Panel -->
          <div class="settings-list-panel">
            <div class="settings-list-header">
              <span id="settings-list-title">Networks</span>
              <button class="entity-add-btn-inline" id="settings-add-btn" title="Add"><i class="fas fa-plus"></i></button>
            </div>
            <div class="settings-list-content">
              <div id="settings-entity-list" class="entity-list"></div>
            </div>
          </div>
          <!-- Editor Panel -->
          <div class="settings-editor-panel">
            <div class="tab-bar">
              <div class="tab-bar-tabs">
                <span class="tab-bar-label"><i class="fas fa-edit"></i> <span id="manage-editor-title">Select an entity to edit</span></span>
              </div>
            </div>
            <div class="manage-editor-area">
              <div id="manage-editor" class="manage-editor">
                <div class="manage-placeholder">
                  <i class="fas fa-cog"></i>
                  <span>Select an entity from the sidebar to edit, or click "Add" to create a new one.</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Status Bar -->
  <div class="statusbar">
    <div class="statusbar-left">
      <div class="statusbar-item">
        <span id="connection-status" class="statusbar-dot dot-connecting"></span>
        <span id="connection-text">Connecting...</span>
      </div>
    </div>
    <div class="statusbar-right">
      <div class="statusbar-item">
        <i class="fas fa-microchip"></i> <span id="statusbar-nodes-text">0 nodes</span>
      </div>
      <div class="statusbar-item">
        <i class="fas fa-globe-americas"></i> <span id="statusbar-region-text">EU_868</span>
      </div>
      <div class="statusbar-item">
        <i class="fas fa-lock"></i> AES-CTR
      </div>
      <div class="statusbar-item">
        <i class="fas fa-server"></i> <span id="statusbar-broker-text">mqtt.meshtastic.org</span>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast">
    <i class="fas fa-check-circle"></i>
    <span id="toast-message">Message sent!</span>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module" src="/js/app.js"></script>
</body>
</html>
